function ReportGroup(a){angular.extend(this,a),this.appliedFilters={},this.refreshState()}var usinReportsApp=angular.module("usinReportsApp",["ngMaterial","ui.select","usinPartials"],usinHelpers.config.httpProvider).config(usinHelpers.config.animateProvider).config(usinHelpers.config.mdThemingProvider).config(usinHelpers.config.mdDateLocaleProvider).value("options",{}).run(["options",function(a){angular.copy(window.USIN,a)}]);angular.module("usinReportsApp").filter("group",function(){return function(a,b){var c=a.filter(function(a){return a.group===b.id});return c}}),USIN.chartCtrl=function(a,b){var c,d=b[0].getElementsByTagName("canvas")[0],e=this;this.$onChanges=function(a){a.chartOptions&&e.chartOptions&&(c&&"function"==typeof c.destroy&&c.destroy(),e.initChart())},this.getChartInstance=function(){return c},this.initChart=function(){c=new Chart(d.getContext("2d"),e.chartOptions)}},usinReportsApp.component("usinChart",{templateUrl:USIN.viewsURL+"/chart.html",bindings:{chartOptions:"<"},controller:["$scope","$element",USIN.chartCtrl]}),USIN.mainCtrl=function(a,b,c,d,e){function f(){var a=i.get(h);if(a){var b=j.reportGroups.filter(function(b){return b.id===a});if(b.length>0)return b[0]}return j.reportGroups[0]}function g(a){j.currentGroup=a,i.set(h,a.id)}var h="report_group",i=usinHelpers.session,j=this;this.reports=c.reports,this.reportGroups=c.reportGroups.map(function(a){return new ReportGroup(a)}),this.currentGroup=f(),this.strings=c.strings,this.isLoading=function(){return d.isLoading()},this.changeGroup=function(a){d.clearQueue(),g(a)},this.changeReportVisibility=function(a,b){a.visible=b},this.onGroupFiltersChange=function(){this.currentGroup.refreshState(),a.$parent.$broadcast("usinGroupFiltersChanged")},this.findReportById=function(a){return this.reports.filter(function(b){return b.id===a})[0]},a["export"]=function(){var a=b.find("usin-report"),c=[];angular.forEach(a,function(a){c.push(angular.element(a).controller("usinReport"))}),e.run(c)}},ReportGroup.prototype=angular.extend(ReportGroup.prototype,{isAwaitingFilterSelection:!1,hasFilters:function(){return"undefined"!=typeof this.filters},hasAppliedFilters:function(){return Object.keys(this.appliedFilters).length>0},refreshState:function(){this.isAwaitingFilterSelection=this.hasFilters()&&!this.hasAppliedFilters()}}),usinReportsApp.component("usinMain",{templateUrl:USIN.viewsURL+"/main.html",controller:["$scope","$element","options","UsinReportQuery","UsinReportExport",USIN.mainCtrl]}),USIN.reportCtrl=function(a,b){var c=this;this.displayed=!1,this.strings=b.strings,this.toggleMenu=function(){c.displayed=!c.displayed},this.onCheckboxChange=function(b){var d=!b.visible;c.onVisibilityChange({report:b,newVisibility:d}),a.updateReportVisiblity(b,d)}},usinReportsApp.component("usinReportToggle",{templateUrl:USIN.viewsURL+"/report-toggle.html",bindings:{reports:"<",group:"<",onVisibilityChange:"&"},controller:["UsinReportQuery","options",USIN.reportCtrl]}),USIN.reportCtrl=function(a,b,c,d,e,f,g){var h=this,i="_",j="custom_period";this.loading=!0,this.chartOptions=null,this.error=null,this.notice=null,this.page=0,this.resData=null,this.loadNextPage=function(){0!==this.page&&(this.page-=1,this.loadData())},this.loadPrevPage=function(){this.page+=1,this.loadData()},this.customPeriodOptions={name:d.strings.custom,start:null,end:null,humanizeDate:function(a){return c.dateStringToPrettyString(a)},argumentizeDate:function(a){return a||"none"},refreshName:function(){this.name=c.periodName(this.start,this.end,d.strings.custom)},toArgs:function(){return this.argumentizeDate(this.start)+i+this.argumentizeDate(this.end)}},f.customPeriodOptions=this.customPeriodOptions,f.strings=d.strings,this.getChartInstance=function(){var a=g.find("usin-chart").controller("usinChart");return a?a.getChartInstance():null},this.getTitle=function(){return this.reportOptions.name},this.getGroupFilters=function(){var a=this.getGroup();return this.groupFilters&&this.groupFilters.constructor===Object?Object.keys(this.groupFilters).map(function(b){var c=a.filters.filter(function(a){return a.id==b})[0],d=c.options.filter(function(a){return a.key==this.groupFilters[b]}.bind(this))[0];return{key:b,value:this.groupFilters[b],name:d.val}}.bind(this)):[]},this.getFilterName=function(){return this.hasFilters()?this.filter==j?this.customPeriodOptions.name:this.reportOptions.filters.options[this.filter]:null},this.getData=function(){return this.resData},this.getGroup=function(){var a=this.reportOptions.group;return groups=d.reportGroups.filter(function(b){return b.id==a})[0]},this.supportsPagination=function(){return"periodic"==this.reportOptions.subtype},this.loadData=function(){this.error=null,this.notice=null,this.loading=!0,a.getReport(this.getQueryArgs()).then(function(a){a.data.notice?h.notice=a.data.notice:(h.resData=a.data,h.chartOptions=b.format(a.data,h.reportOptions))},function(a){h.error=a.data&&a.data.error||d.strings.errorLoading})["finally"](function(){h.loading=!1})},this.getQueryArgs=function(){var a={report_id:this.reportOptions.id};return this.hasFilters()&&(this.filter==j?a.filter=this.customPeriodOptions.toArgs():a.filter=this.filter),a.group_filters=this.groupFilters,this.supportsPagination()&&(a.page=this.page),a},this.hasFilters=function(){return"undefined"!=typeof this.reportOptions.filters},this.onFilterChange=function(){this.page=0,this.loadData()},f.$on("usinGroupFiltersChanged",this.onFilterChange.bind(this)),this.shouldEnableSearch=function(){return this.hasFilters()&&Object.keys(this.reportOptions.filters.options).length>10},f.applyCustomPeriod=function(){h.customPeriodOptions.refreshName(),e.cancel(),h.onFilterChange()},this.onCustomPeriodClicked=function(a,b){a.stopPropagation(),a.preventDefault(),h.filter=j,b.close(),e.show({scope:f,preserveScope:!0,controller:"UsinPeriodSelectCtrl",templateUrl:d.viewsURL+"/period-select-dialog.html",parent:angular.element(document.body),clickOutsideToClose:!0})},f.closeDialog=function(){e.cancel()},this.$onInit=function(){this.hasFilters()&&(this.filter=this.reportOptions.filters["default"]),this.loadData()}},usinReportsApp.component("usinReport",{templateUrl:USIN.viewsURL+"/report.html",bindings:{reportOptions:"<",groupFilters:"<"},controller:["UsinReportQuery","UsinReportData","UsinDate","options","$mdDialog","$scope","$element",USIN.reportCtrl]}),usinReportsApp.controller("UsinPeriodSelectCtrl",function(){}),usinReportsApp.factory("UsinReportData",["options",function(a){function b(a,b,c){return{labels:a.labels,datasets:a.datasets.map(function(b){var d={label:b.name,backgroundColor:b.getBackgroundColors(c),data:b.values};return a.datasets.length>1&&(d.borderWidth=0),d})}}function c(a,b){if(!a)return a;for(var c=[],d="",e=a.split(" "),f=0;f<e.length;f++){var g=e[f];d.length+g.length>b&&(c.push(d.trim()),d=""),d+=g+" "}return d&&c.push(d.trim()),c}function d(d,e){var f="periodic"==e.subtype?"#00aba8":null,g=d.length>2&&d.labels[0]&&d.labels[0].length>10?70:0,h={type:"bar",data:b(d,e.type,f),options:{legend:{position:"bottom",display:d.datasets.length>1&&d.hasData(),labels:{fontColor:"#7c838d",boxWidth:12}},scales:{xAxes:[{gridLines:{color:"rgba(0, 0, 0, 0)"},ticks:{minRotation:g,fontColor:"#7c838d",autoSkip:!1,callback:function(a){var b=12;return a.length>=b?a.slice(0,a.length).substring(0,b-1).trim()+"..":a}}}],yAxes:[{ticks:{beginAtZero:!0,fontColor:"#7c838d",userCallback:function(a,b,c){return Math.floor(a)===a?a:void 0}},gridLines:{color:"rgba(0, 0, 0, 0.03)",zeroLineColor:"#dbe3ec"}}]},tooltips:{callbacks:{title:function(a){var b=this._data.labels[a[0].index],d=30;return b&&b.length>d?c(b,d):b}},mode:"index"}}};if("bar-stacked"==e.type&&(h.options.scales.yAxes[0].stacked=!0,h.options.scales.xAxes[0].stacked=!0,h.options.tooltips.callbacks.footer=function(b){var c=0,d=b.length===this._data.datasets.length;return d?(b.forEach(function(a){c+=Number(this._data.datasets[a.datasetIndex].data[a.index])}.bind(this)),a.strings.total+": "+c):void 0}),e.format&&"float"==e.format&&(h.options.tooltips.callbacks.label=function(a){var b=parseFloat(a.yLabel);return!isNaN(b)&&isFinite(b)?b.toFixed(2):b}),d.length<=3){var i=1==d.datasets.length?50:35;h.options.scales.xAxes[0].barThickness=i}return h}function e(c,d){var e=null,h=!0;return c.length||(c=new g([new f({items:[{total:1,label:a.strings.noResults}]})]),e="#dddddd",h=!1),{type:"doughnut",data:b(c,d.type,e),options:{legend:{position:"top",labels:{fontColor:"#7c838d",boxWidth:12,filter:function(a,b){return a.index<5?a:void 0}},display:!0},tooltips:{enabled:h}}}}function f(a){this._options=a,this.items=a.items,this.length=this.items.length,this.name=a.name,this.labels=this.items.map(function(a){return a.label}),this.values=this.items.map(function(a){return a.total})}function g(a){a="undefined"!=typeof a?a:[],this.datasets=a.map(function(a){return new f(a)}),this.length=this.datasets.length&&this.datasets[0].length,this.labels=this.length>0?this.datasets[0].labels:[]}return f.prototype=angular.extend(f.prototype,{_colors:["#00aba8","#1aa6c9","#f05d5d","#eb5b95","#fcb867","#a379db","#43adde","#38ba8d","#5669e3","#f05d91","#fa8f5a","#7ecf65"],getBackgroundColors:function(a){return this.items.map(function(b,c){return b.color||this._options.color||a||this._colors[c]}.bind(this))},hasData:function(){var a=!1;return angular.forEach(this.values,function(b){0!==b&&null!==b&&(a=!0)}),a}}),g.prototype=angular.extend(g.prototype,{hasData:function(){var a=!1;return angular.forEach(this.datasets,function(b){b.hasData()&&(a=!0)}),a}}),{format:function(a,b){var c=new g(a);return"bar"==b.type||"bar-stacked"==b.type?d(c,b):"pie"==b.type?e(c,b):void 0}}}]),usinReportsApp.factory("UsinReportExport",["options",function(a){function b(a){this.pdf=new window.jspdf.jsPDF,this.reports=a}function c(a,b){this.pdf=b,this.report=a,this.chart=a.getChartInstance(),this.yOffset=15}a.strings;return b.prototype=angular.extend(b.prototype,{run:function(){var a=0;angular.forEach(this.reports,function(b,d){if(b){var e=new c(b,this.pdf).run();a+=e?1:0,e&&d<this.reports.length-1&&this.pdf.addPage()}}.bind(this)),a>0&&this.pdf.save("reports.pdf")}}),c.prototype=angular.extend(c.prototype,{run:function(){return this.chart?(this._printSubtitle(),this.yOffset+=8,this._printTitle(),this.yOffset+=10,this._printChart(),this._printTable(),!0):!1},_printSubtitle:function(){var a=this.report.getGroup(),b=this.report.getGroupFilters(),c=[a.name];if(b.length){var d=b.map(function(a){return a.name});c.push(d.join(", "))}var e=c.join(" - ");this.pdf.setFontSize(9).setTextColor(124,124,124),this.pdf.text(e,this._getPdfWidth()/2,this.yOffset,{align:"center"})},_printTitle:function(){var a=[this.report.getTitle()],b=this.report.getFilterName();b&&a.push(b),this.pdf.setFontSize(12).setTextColor(59,68,79),this.pdf.text(a.join(" - "),this._getPdfWidth()/2,this.yOffset,{align:"center"})},_printChart:function(){var a=this._getChartWidth(),b=this._getChartHeight(),c=this._getPdfWidth(),d=(c-a)/2,e=this.chart.toBase64Image();this.pdf.addImage(e,"PNG",d,this.yOffset,a,b),this.yOffset+=b+10},_printTable:function(){var a=this.report.getData(),b=["Label"],c=[];a.forEach(function(a){b.push(a.name||"Total")});var d=a[0].items.map(function(a){return a.label});d.forEach(function(b,d){var e=[b];a.forEach(function(a){e.push(a.items[d].total)}),c.push(e)}),this.pdf.autoTable({head:[b],body:c,startY:this.yOffset,theme:"grid",headStyles:{fillColor:[59,68,79]},columnStyles:function(){for(var a={0:{}},c=1;c<b.length;c++)a[c]={halign:"right"};return a}()})},_getChartWidth:function(){return 100},_getChartHeight:function(){var a=this.chart.canvas,b=a.width,c=a.height,d=c/b;return this._getChartWidth()*d},_getPdfWidth:function(){return this.pdf.internal.pageSize.getWidth()}}),{run:function(a){var c=new b(a);c.run()}}}]),usinReportsApp.factory("UsinReportQuery",["options","$http","$cacheFactory","$q",function(a,b,c,d){var e=c("lru",{capacity:100}),f=[],g=function(){var a=f[0];b(a.config).then(function(b){a.deferred.resolve(b)},function(b){a.deferred.reject(b)})["finally"](function(){f.shift(),f.length>0&&g()})};return{getReport:function(b){var c=d.defer(),h={method:"get",url:a.ajaxURL,params:angular.extend({action:"usin_get_report",nonce:a.nonce},b),cache:e};return f.push({config:h,deferred:c}),1===f.length&&g(),c.promise},isLoading:function(){return f.length>0},clearQueue:function(){f=[]},updateReportVisiblity:function(c,d){var e={action:"usin_update_report_visibility",nonce:a.nonce,report_id:c.id,visibility:d};return b({method:"post",url:a.ajaxURL,data:e})}}}]);
//# sourceMappingURL=reports.min.js.map